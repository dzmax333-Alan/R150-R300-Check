<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSMB 智能驗證系統 (單機版)</title>
    
    <!-- 1. 引入 Tailwind CSS (樣式庫) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 和 ReactDOM (核心框架) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 引入 Babel (讓瀏覽器看不懂的 JSX 變成看得懂的 JS) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 引入 SheetJS (讀取 Excel 用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; }
        /* 自定義動畫 */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.5s ease-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 設定 React 變數 ---
        const { useState, useRef, useEffect, useMemo, useCallback } = React;

        // --- 定義圖示組件 (內建 SVG，不依賴外部庫) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Scan = (props) => <IconBase {...props}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></IconBase>;
        const Volume2 = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></IconBase>;
        const VolumeX = (props) => <IconBase {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></IconBase>;
        const QrCode = (props) => <IconBase {...props}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h7v7H3z"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Ruler = (props) => <IconBase {...props}><path d="M2 12.5a.5.5 0 0 1 .5-.5h21a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5h-21a.5.5 0 0 1-.5-.5v-3Z"/><path d="M5 12v3"/><path d="M9 12v3"/><path d="M13 12v3"/><path d="M17 12v3"/><path d="M21 12v3"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Type = (props) => <IconBase {...props}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Cpu = (props) => <IconBase {...props}><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></IconBase>;


        // --- 核心演算法 (OSMB-BASE64) ---
        const formatMacAddress = (macRaw) => {
            if (!macRaw) return "";
            let clean = String(macRaw).trim().replace(/[^a-zA-Z0-9]/g, '');
            if (clean.length < 12) clean = clean.padStart(12, '0');
            if (clean.length === 12) {
                return clean.match(/.{1,2}/g).join(':').toUpperCase();
            }
            return clean;
        };

        const generateOSMB = (macRaw, poRaw) => {
            try {
                const macFormatted = formatMacAddress(macRaw);
                const po = String(poRaw).trim();
                const payload = `0\n${macFormatted}\n${po}`;
                return btoa(payload);
            } catch (e) {
                console.error("OSMB Generation Error", e);
                return "ERROR";
            }
        };

        // --- 音效工具 ---
        const playSound = (type) => {
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            osc.connect(gain);
            gain.connect(ctx.destination);

            const now = ctx.currentTime;

            if (type === 'step1_ok') {
              osc.type = 'sine';
              osc.frequency.setValueAtTime(600, now);
              osc.frequency.linearRampToValueAtTime(800, now + 0.1);
              gain.gain.setValueAtTime(0.3, now);
              gain.gain.linearRampToValueAtTime(0.01, now + 0.15);
              osc.start(now);
              osc.stop(now + 0.15);
            } else if (type === 'success') {
              osc.type = 'sine';
              osc.frequency.setValueAtTime(1046.50, now); 
              gain.gain.setValueAtTime(0.3, now);
              gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
              
              const osc2 = ctx.createOscillator();
              const gain2 = ctx.createGain();
              osc2.connect(gain2);
              gain2.connect(ctx.destination);
              osc2.type = 'sine';
              osc2.frequency.setValueAtTime(1318.51, now + 0.15); 
              gain2.gain.setValueAtTime(0.3, now + 0.15);
              gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
              
              osc.start(now);
              osc.stop(now + 0.2);
              osc2.start(now + 0.15);
              osc2.stop(now + 0.6);
            } else if (type === 'error') {
              osc.type = 'sawtooth';
              osc.frequency.setValueAtTime(150, now);
              osc.frequency.linearRampToValueAtTime(100, now + 0.4);
              gain.gain.setValueAtTime(0.5, now);
              gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
              osc.start(now);
              osc.stop(now + 0.4);
            } else if (type === 'autosave') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
          } catch (e) {
            console.error("Audio play failed", e);
          }
        };

        // --- 主程式 ---
        function App() {
          const [masterData, setMasterData] = useState(new Map());
          const [scanHistory, setScanHistory] = useState([]);
          const [inputVal, setInputVal] = useState('');
          const [status, setStatus] = useState('idle'); 
          const [errorMsg, setErrorMsg] = useState('');
          
          const [scanStep, setScanStep] = useState('barcode'); 
          const [currentProduct, setCurrentProduct] = useState(null); 

          const [soundEnabled, setSoundEnabled] = useState(true);
          const [autoSubmit, setAutoSubmit] = useState(true);
          const [autoSaveEnabled, setAutoSaveEnabled] = useState(true); // 新增：自動存檔開關狀態
          const [fileName, setFileName] = useState('');
          const [isExcelReady, setIsExcelReady] = useState(false);
          const [restoreMsg, setRestoreMsg] = useState(''); 
          const [lastAutoSaveTime, setLastAutoSaveTime] = useState(null); 
          
          const inputRef = useRef(null);
          const scanHistoryRef = useRef(scanHistory);
          const fileNameRef = useRef(fileName);

          useEffect(() => {
            scanHistoryRef.current = scanHistory;
            fileNameRef.current = fileName;
          }, [scanHistory, fileName]);

          // 自動存檔邏輯
          useEffect(() => {
            if (!autoSaveEnabled) return; // 如果關閉，就不執行

            const AUTO_SAVE_INTERVAL = 30 * 60 * 1000;
            const timer = setInterval(() => {
              const currentHistory = scanHistoryRef.current;
              const currentFileName = fileNameRef.current;
              if (currentFileName && currentHistory.length > 0) {
                performDownload(currentHistory, true);
                const nowStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                setLastAutoSaveTime(nowStr);
                if (soundEnabled) playSound('autosave');
              }
            }, AUTO_SAVE_INTERVAL);
            return () => clearInterval(timer);
          }, [soundEnabled, autoSaveEnabled]); // 加入 autoSaveEnabled 依賴

          // LocalStorage 恢復邏輯
          useEffect(() => {
            try {
              const savedFileName = localStorage.getItem('sv_fileName');
              if (savedFileName) setFileName(savedFileName);
              
              const savedHistory = localStorage.getItem('sv_history');
              if (savedHistory) setScanHistory(JSON.parse(savedHistory));

              const savedMasterData = localStorage.getItem('sv_masterData');
              if (savedMasterData) {
                const mapArray = JSON.parse(savedMasterData);
                setMasterData(new Map(mapArray));
                if (savedFileName) {
                    setRestoreMsg(`已恢復：${savedFileName}`);
                    setTimeout(() => setRestoreMsg(''), 5000);
                }
              }
            } catch (e) {
              console.error("Restore failed", e);
              localStorage.removeItem('sv_masterData'); 
            }
          }, []);

          // 儲存到 LocalStorage
          useEffect(() => {
            try {
              localStorage.setItem('sv_history', JSON.stringify(scanHistory));
            } catch (e) {}
          }, [scanHistory]);

          const saveMasterDataToStorage = (mapData, fName) => {
            try {
              const mapArray = Array.from(mapData.entries());
              localStorage.setItem('sv_masterData', JSON.stringify(mapArray));
              localStorage.setItem('sv_fileName', fName);
            } catch (e) {
              console.warn("Storage full", e);
              localStorage.removeItem('sv_masterData'); 
              localStorage.setItem('sv_fileName', fName); 
              alert("⚠️ 檔案較大，無法啟用「斷電恢復」。");
            }
          };

          // --- 這裡移除了 clearAllData 函式 ---

          // 焦點控制
          useEffect(() => {
            const focusInput = () => { if (inputRef.current) inputRef.current.focus(); };
            focusInput();
            const handleBodyClick = (e) => {
              if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && e.target.type !== 'file' && e.target.tagName !== 'LABEL') {
                focusInput();
              }
            };
            document.addEventListener('click', handleBodyClick);
            return () => document.removeEventListener('click', handleBodyClick);
          }, []);

          // 檢查 Excel 庫
          useEffect(() => {
            if (window.XLSX) setIsExcelReady(true);
          }, []);

          const stats = useMemo(() => {
            const total = scanHistory.length;
            const ok = scanHistory.filter(i => i.status === 'success').length;
            const err = scanHistory.filter(i => i.status === 'error').length;
            return { total, ok, err };
          }, [scanHistory]);

          const processDataRows = (rows, originalFileName) => {
            if (!rows || rows.length < 2) {
                alert("檔案內容為空或格式錯誤");
                return;
            }

            const headers = rows[0].map(h => String(h || '').trim());
            
            // 修改：支援 Barcode, 序號, IONODES S/N
            const barcodeIdx = headers.findIndex(h => {
                const low = h.toLowerCase();
                return low.includes('barcode') || h.includes('序號') || low.includes('ionodes s/n');
            });
            
            // 修改：支援 MAC 或 ETH1
            const macIdx = headers.findIndex(h => {
                const up = h.toUpperCase();
                return up.includes('MAC') || up.includes('ETH1');
            });

            // 修改：支援 PEN, PO, PIN #, PONUMBER, PENNumber
            // 註: includes('pen') 已涵蓋 PENNumber, includes('po') 已涵蓋 PONUMBER
            const penIdx = headers.findIndex(h => {
                const low = h.toLowerCase();
                return low.includes('pen') || low.includes('po') || low.includes('pin #') || low.includes('pin_');
            });

            const osmbIdx = headers.findIndex(h => h.includes('OSMB'));

            if (barcodeIdx === -1) { alert("錯誤：找不到 'barcode' 或 '序號' 欄位"); return; }
            if (macIdx === -1 || penIdx === -1) { alert("錯誤：檔案必須包含 'MAC/ETH1' 與 'PEN/PO/PIN #' 欄位。"); return; }

            const newMap = new Map();
            let count = 0;

            for (let i = 1; i < rows.length; i++) {
              const cols = rows[i];
              const getVal = (idx) => idx !== -1 && cols[idx] !== undefined ? String(cols[idx]).trim() : '';
              
              const barcode = getVal(barcodeIdx);
              const mac = getVal(macIdx);
              const pen = getVal(penIdx);
              const originalOsmb = getVal(osmbIdx);
              
              if (barcode) {
                const calculatedOsmb = generateOSMB(mac, pen);
                newMap.set(barcode, {
                  barcode, mac, pen: pen || 'N/A',
                  expectedOsmb: calculatedOsmb,
                  fileOsmb: originalOsmb,
                  rowLine: i + 1
                });
                count++;
              }
            }

            setMasterData(newMap);
            resetProcess();
            setScanHistory([]); 
            setLastAutoSaveTime(null);
            saveMasterDataToStorage(newMap, originalFileName);
            alert(`載入成功：${count} 筆資料。\n系統已啟用「OSMB-BASE64」驗證邏輯。`);
          };

          const handleFileUpload = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            setFileName(file.name);
            const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');

            if (isExcel) {
                if (!isExcelReady) { alert("Excel 解析模組尚未載入"); return; }
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});
                        processDataRows(jsonData, file.name);
                    } catch (error) {
                        console.error(error);
                        alert("Excel 讀取失敗");
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const text = event.target.result;
                    const lines = text.split('\n');
                    const parseCSVLine = (line) => {
                        const result = [];
                        let start = 0;
                        let inQuotes = false;
                        for (let i = 0; i < line.length; i++) {
                          if (line[i] === '"') inQuotes = !inQuotes;
                          else if (line[i] === ',' && !inQuotes) {
                            result.push(line.substring(start, i).replace(/^"|"$/g, '').trim());
                            start = i + 1;
                          }
                        }
                        result.push(line.substring(start).replace(/^"|"$/g, '').trim());
                        return result;
                    };
                    const rows = lines.filter(line => line.trim() !== '').map(parseCSVLine);
                    processDataRows(rows, file.name);
                };
                reader.readAsText(file);
            }
          };

          const performDownload = (historyData, isAutoSave = false) => {
            const BOM = "\uFEFF"; 
            const header = "時間,狀態,Barcode,PEN_Number,MAC_Address,Scanned_OSMB,Expected_OSMB,備註\n";
            const rows = [...historyData].map(item => {
              const statusStr = item.status === 'success' ? 'OK' : 'FAIL';
              const safe = (str) => str ? `"${str.toString().replace(/"/g, '""')}"` : ''; 
              return `${item.time},${statusStr},${safe(item.code)},${safe(item.pen)},${safe(item.mac)},${safe(item.osmb)},${safe(item.expected)},${safe(item.msg)}`;
            }).join("\n");

            const blob = new Blob([BOM + header + rows], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
            link.href = url;
            link.download = isAutoSave ? `ScanLog_AutoSave_${timestamp}.csv` : `ScanLog_${timestamp}.csv`;
            link.click();
            URL.revokeObjectURL(url);
          };

          const resetProcess = (clearStatus = true) => {
            setScanStep('barcode');
            setCurrentProduct(null);
            setInputVal('');
            if (clearStatus) {
              setStatus('idle');
              setErrorMsg('');
            }
          };

          const handleScan = useCallback((e) => {
            if (e) e.preventDefault();
            if (!inputVal.trim()) return;
            
            if (!fileName || masterData.size === 0) {
                if (fileName && masterData.size === 0) alert(`請重新載入檔案：${fileName}`);
                setInputVal('');
                return; 
            }

            const scannedCode = inputVal.trim();
            const timestamp = new Date().toLocaleTimeString();

            if (scanStep === 'barcode') {
              const match = masterData.get(scannedCode);
              if (match) {
                setCurrentProduct(match);
                setScanStep('osmb');
                setStatus('step1_ok');
                setErrorMsg('');
                if (soundEnabled) playSound('step1_ok');
              } else {
                setStatus('error');
                setErrorMsg(`無此序號: ${scannedCode}`);
                if (soundEnabled) playSound('error');
                setScanHistory(prev => [{
                  status: 'error', time: timestamp, msg: '無此序號',
                  code: scannedCode, expected: '-', pen: '-', mac: '-'
                }, ...prev]);
              }
            } else {
              if (scannedCode.length !== 40) {
                setStatus('error');
                setErrorMsg(`OSMB 長度錯誤! (目前:${scannedCode.length}, 應為:40)`);
                if (soundEnabled) playSound('error');
                setScanHistory(prev => [{
                  status: 'error', time: timestamp, msg: `長度錯誤(${scannedCode.length})`,
                  code: currentProduct.barcode, osmb: scannedCode, expected: 'Length: 40',
                  pen: currentProduct.pen, mac: currentProduct.mac
                }, ...prev]);
                resetProcess(false);
                setInputVal('');
                return; 
              }

              const upperCaseCount = (scannedCode.match(/[A-Z]/g) || []).length;
              if (upperCaseCount > 25) {
                setStatus('error');
                setErrorMsg(`大寫字母過多! (${upperCaseCount})`);
                if (soundEnabled) playSound('error');
                setScanHistory(prev => [{
                  status: 'error', time: timestamp, msg: `字母過多(${upperCaseCount})`,
                  code: currentProduct.barcode, osmb: scannedCode, expected: 'UpperChars <= 25',
                  pen: currentProduct.pen, mac: currentProduct.mac
                }, ...prev]);
                resetProcess(false);
                setInputVal('');
                return;
              }

              const expectedOSMB = currentProduct.expectedOsmb;
              const isMatch = scannedCode === expectedOSMB;

              if (isMatch) {
                setStatus('success');
                setScanHistory(prev => [{
                  status: 'success', time: timestamp, msg: '比對成功',
                  code: currentProduct.barcode, osmb: scannedCode, expected: expectedOSMB,
                  pen: currentProduct.pen, mac: currentProduct.mac
                }, ...prev]);
                if (soundEnabled) playSound('success');
                setTimeout(() => resetProcess(false), 1500); 
              } else {
                setStatus('error');
                setErrorMsg(`OSMB 內容不符！`);
                if (soundEnabled) playSound('error');
                let errorNote = '計算結果不符';
                if (currentProduct.fileOsmb && scannedCode === currentProduct.fileOsmb) {
                    errorNote += '(但符合檔案欄位)';
                }
                setScanHistory(prev => [{
                  status: 'error', time: timestamp, msg: errorNote,
                  code: currentProduct.barcode, osmb: scannedCode, expected: expectedOSMB,
                  pen: currentProduct.pen, mac: currentProduct.mac
                }, ...prev]);
                resetProcess(false);
              }
            }
            setInputVal('');
          }, [inputVal, fileName, masterData, scanStep, currentProduct, soundEnabled]);

          useEffect(() => {
            if (!autoSubmit || !inputVal) return;
            const timeoutId = setTimeout(() => handleScan(), 200);
            return () => clearTimeout(timeoutId);
          }, [inputVal, autoSubmit, handleScan]);

          const getBgColor = () => {
            if (status === 'error') return 'bg-red-600';
            if (status === 'success') return 'bg-green-500';
            if (scanStep === 'osmb') return 'bg-blue-600';
            return 'bg-slate-800';
          };

          return (
            <div className={`h-screen overflow-hidden transition-colors duration-300 flex flex-col ${getBgColor()}`}>
              
              {/* 頂部選單 (極簡化版) */}
              <div className="flex-shrink-0 bg-black/30 backdrop-blur-md p-2 text-white flex justify-between items-center relative z-20">
                <div className="flex items-center gap-2">
                  <Scan className="w-6 h-6" /> {/* 僅保留圖示，移除文字 */}
                  <div>
                    {restoreMsg && (
                        <div className="absolute top-full left-2 mt-1 bg-green-500 text-white text-xs px-2 py-1 rounded shadow animate-fade-in whitespace-nowrap z-50">
                            {restoreMsg}
                        </div>
                    )}
                  </div>
                </div>
                <div className="flex gap-1 items-center">
                  
                  {scanStep === 'osmb' && (
                    <button onClick={() => resetProcess(true)} className="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded-lg font-bold transition flex items-center gap-1 border border-white/30 text-sm">
                      <ArrowLeft className="w-4 h-4" /> 上一步
                    </button>
                  )}
                  
                  {/* 自動存檔開關按鈕 */}
                  {fileName && (
                    <button onClick={() => setAutoSaveEnabled(!autoSaveEnabled)} 
                            className={`p-1.5 rounded-full transition ${autoSaveEnabled ? 'bg-green-400 text-slate-900' : 'hover:bg-white/20 text-white/50'}`} 
                            title={autoSaveEnabled ? "自動存檔已開啟 (每30分鐘)" : "自動存檔已關閉"}>
                        <Clock className="w-5 h-5" />
                    </button>
                  )}

                  <button onClick={() => setAutoSubmit(!autoSubmit)} className={`p-1.5 rounded-full transition ${autoSubmit ? 'bg-yellow-400 text-slate-900' : 'hover:bg-white/20 text-white/50'}`} title={autoSubmit ? "自動送出已開啟" : "自動送出已關閉"}>
                    <Zap className="w-5 h-5" />
                  </button>
                  <button onClick={() => setSoundEnabled(!soundEnabled)} className="p-1.5 rounded-full hover:bg-white/20" title="聲音開關">
                    {soundEnabled ? <Volume2 className="w-5 h-5" /> : <VolumeX className="w-5 h-5" />}
                  </button>
                  <button onClick={() => resetProcess()} className="p-1.5 rounded-full hover:bg-white/20" title="重置">
                    <RotateCcw className="w-5 h-5" />
                  </button>
                  {fileName && scanHistory.length > 0 && (
                    <button onClick={() => performDownload(scanHistory)} className="p-1.5 rounded-full hover:bg-white/20 text-green-300" title="匯出 Log">
                      <Save className="w-5 h-5" />
                    </button>
                  )}

                  <label htmlFor="file-upload-input" className="cursor-pointer flex items-center gap-1 bg-blue-600 hover:bg-blue-500 px-3 py-1.5 rounded-lg font-bold transition shadow-lg text-sm">
                    <Upload className="w-4 h-4" />
                    <span className="hidden sm:inline">載入</span>
                  </label>
                  <input id="file-upload-input" type="file" accept=".csv, .xlsx, .xls" onChange={handleFileUpload} className="hidden" />
                </div>
              </div>

              {/* 主要區域 */}
              <div className="flex-1 overflow-y-auto flex flex-col items-center justify-center p-4 w-full max-w-5xl mx-auto text-white text-center relative z-10">
                
                {fileName ? (
                  <div className="mb-6 bg-white/20 backdrop-blur-md px-6 py-2 rounded-full border border-white/10 flex items-center gap-2 animate-fade-in shadow-lg">
                    <FileText className="w-4 h-4 text-blue-200" />
                    <span className="text-sm font-medium text-blue-100">目前檔案：</span>
                    <span className="font-bold text-white tracking-wide font-mono">{fileName}</span>
                  </div>
                ) : (
                  <label htmlFor="file-upload-input" className="mb-8 cursor-pointer transform hover:scale-105 transition-transform duration-300 group">
                     <div className="bg-rose-500/90 backdrop-blur-md px-8 py-6 rounded-2xl border-2 border-white/30 flex items-center gap-4 shadow-[0_0_50px_rgba(244,63,94,0.6)] animate-pulse group-hover:bg-rose-600/90">
                        <div className="bg-white/20 p-3 rounded-full"><AlertTriangle className="w-10 h-10 text-white" /></div>
                        <div className="text-left">
                           <h3 className="text-2xl font-bold text-white tracking-wide">尚未載入資料</h3>
                           <p className="text-rose-100 font-medium mt-1">請載入包含 MAC 與 PEN/PO 的 Excel</p>
                        </div>
                     </div>
                  </label>
                )}

                <div className="mb-8 min-h-[200px] w-full flex flex-col items-center justify-center">
                  {status === 'error' && (
                    <div className="animate-shake">
                      <XCircle className="w-32 h-32 mx-auto mb-4 text-white/90 drop-shadow-lg" />
                      <h2 className="text-4xl font-bold">錯誤 ERROR</h2>
                      <p className="text-2xl bg-black/20 px-6 py-2 rounded-full inline-block">{errorMsg}</p>
                      <div className="flex gap-4 justify-center mt-4">
                          {scanHistory[0]?.msg?.includes('長度') && <div className="bg-white/10 px-4 py-2 rounded-lg flex items-center gap-2"><Ruler className="text-yellow-300"/> <span className="text-yellow-300">標準：40 字元</span></div>}
                          {scanHistory[0]?.msg?.includes('字母') && <div className="bg-white/10 px-4 py-2 rounded-lg flex items-center gap-2"><Type className="text-yellow-300"/> <span className="text-yellow-300">大寫上限：25 個</span></div>}
                      </div>
                      {scanHistory[0]?.expected && scanHistory[0]?.expected !== '-' && !scanHistory[0]?.msg?.includes('錯誤') && (
                         <div className="mt-4 text-left bg-white/10 p-4 rounded-lg text-sm max-w-2xl mx-auto grid grid-cols-2 gap-4">
                             <div><p className="opacity-70 text-xs">正確答案 (計算值):</p><p className="font-mono font-bold text-yellow-300 break-all">{scanHistory[0].expected}</p></div>
                             <div><p className="opacity-70 text-xs">實際掃描:</p><p className="font-mono font-bold text-red-300 break-all">{scanHistory[0].osmb || scanHistory[0].code}</p></div>
                         </div>
                      )}
                    </div>
                  )}

                  {status === 'success' && (
                    <div className="animate-bounce">
                      <CheckCircle className="w-32 h-32 mx-auto mb-4 text-white drop-shadow-lg" />
                      <h2 className="text-5xl font-bold">MATCH!</h2>
                      <p className="text-xl mt-2 opacity-90">符合 OSMB-BASE64 演算法</p>
                      <div className="mt-4 bg-white/20 px-4 py-2 rounded-lg inline-block text-sm">
                         <div className="flex gap-4">
                            <span>MAC: <span className="font-mono font-bold text-yellow-300">{currentProduct?.mac}</span></span>
                            <span>PEN: <span className="font-mono font-bold text-yellow-300">{currentProduct?.pen}</span></span>
                         </div>
                      </div>
                    </div>
                  )}

                  {status !== 'error' && status !== 'success' && scanStep === 'barcode' && fileName && (
                    <div className="animate-pulse">
                        <Scan className="w-32 h-32 mx-auto mb-4 text-white/50" />
                        <h2 className="text-4xl font-bold">請掃描 Barcode</h2>
                    </div>
                  )}

                  {status !== 'error' && status !== 'success' && scanStep === 'osmb' && (
                    <div className="relative w-full max-w-xl">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden animate-fade-in-up text-slate-900 mb-8">
                            <div className="bg-blue-600 p-3 text-center font-bold text-white flex items-center justify-center gap-2"><Cpu className="w-5 h-5" /> OSMB 即時運算完成</div>
                            <div className="p-8 text-center">
                                <div className="text-6xl font-mono font-black text-slate-800 break-all">{currentProduct?.pen || 'N/A'}</div>
                                <div className="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-1 text-sm text-slate-500">
                                    <div className="flex justify-between"><span>Barcode:</span><span className="font-mono font-bold text-slate-700">{currentProduct?.barcode}</span></div>
                                    <div className="flex justify-between"><span>MAC:</span><span className="font-mono font-bold text-slate-700">{currentProduct?.mac}</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col items-center opacity-80">
                            <QrCode className="w-16 h-16 text-white mb-2" />
                            <h2 className="text-2xl font-bold">請掃描 OSMB</h2>
                        </div>
                    </div>
                  )}
                </div>

                <form onSubmit={handleScan} className="w-full max-w-lg relative">
                  <input ref={inputRef} type="text" value={inputVal} onChange={(e) => setInputVal(e.target.value)} onBlur={(e) => setTimeout(() => e.target.focus(), 10)}
                    disabled={!fileName} placeholder={!fileName ? "請先載入檔案..." : (scanStep === 'barcode' ? "等待 Barcode..." : "等待 OSMB...")}
                    className="w-full bg-white/90 text-black text-2xl px-6 py-4 rounded-full shadow-2xl outline-none border-4 border-transparent focus:border-blue-400 text-center font-mono disabled:bg-slate-300" autoComplete="off"
                  />
                </form>
              </div>

              {/* 底部紀錄 */}
              <div className="flex-shrink-0 bg-white h-48 flex flex-col text-slate-800 shadow-[0_-10px_40px_rgba(0,0,0,0.2)] relative z-20">
                <div className="p-2 bg-slate-100 border-b border-slate-200 flex justify-between text-xs font-bold">
                  <div className="flex gap-3">
                    <span>總量: {stats.total}</span>
                    <span className="text-green-600">成功: {stats.ok}</span>
                    <span className="text-red-600">失敗: {stats.err}</span>
                  </div>
                  {/* 這裡移除了清除全部的按鈕 */}
                </div>
                <div className="flex-1 overflow-y-auto">
                  <table className="w-full text-sm text-left">
                    <thead className="text-xs text-slate-500 bg-slate-50 sticky top-0">
                      <tr>
                        <th className="px-4 py-2">狀態</th>
                        <th className="px-4 py-2">Barcode</th>
                        <th className="px-4 py-2">MAC</th>
                        <th className="px-4 py-2">PEN/PO</th>
                        <th className="px-4 py-2">結果</th>
                      </tr>
                    </thead>
                    <tbody>
                      {scanHistory.map((item, idx) => (
                        <tr key={idx} className="border-b border-slate-100 hover:bg-slate-50">
                          <td className="px-4 py-1">
                             {item.status === 'success' ? <span className="bg-green-100 text-green-800 px-2 rounded-full text-xs font-bold">OK</span> : <span className="bg-red-100 text-red-800 px-2 rounded-full text-xs font-bold">ERR</span>}
                          </td>
                          <td className="px-4 py-1 font-mono font-bold text-xs">{item.code}</td>
                          <td className="px-4 py-1 font-mono text-xs">{item.mac}</td>
                          <td className="px-4 py-1 font-mono text-blue-600 font-bold text-xs">{item.pen || '-'}</td>
                          <td className="px-4 py-1 text-xs">{item.status === 'error' ? <span className="text-red-600">{item.msg}</span> : <span className="text-green-600">Match</span>}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>